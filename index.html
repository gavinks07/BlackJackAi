<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blackjack Card Counting PWA</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #2c3e50;
      color: #ecf0f1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      overflow: hidden;
    }
    .container {
      background: #34495e;
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 900px;
      text-align: center;
      position: relative;
    }
    .home-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .home-container input, .home-container select {
      padding: 10px;
      border-radius: 5px;
      border: none;
      margin-bottom: 10px;
    }
    h1 {
      margin-bottom: 20px;
    }
    .dealer, .player {
      margin-bottom: 20px;
    }
    .cards {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-bottom: 10px;
    }
    .card {
      width: 30px;
      height: 40px;
      background: #ecf0f1;
      color: #2c3e50;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 5px;
      font-weight: bold;
    }
    .buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #2980b9;
      color: white;
    }
    .count-display, .suggested-play {
      margin: 10px 0;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    .card-buttons {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    .highlight {
      background: #2c3e50;
    }
    .fixed-buttons {
      position: fixed;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
  </style>
</head>
<body>
  <div class="container" id="home-screen">
    <h1>Blackjack Card Counting PWA</h1>
    <div class="home-container">
      <input type="number" id="num-players" placeholder="Number of players" min="1">
      <select id="num-decks">
        <option value="1">1 Deck</option>
        <option value="2">2 Decks</option>
        <option value="3">3 Decks</option>
        <option value="4">4 Decks</option>
        <option value="5">5 Decks</option>
        <option value="6">6 Decks</option>
        <option value="7">7 Decks</option>
        <option value="8">8 Decks</option>
      </select>
      <input type="number" id="user-position" placeholder="Your position from dealer" min="1">
      <button onclick="startGame()">Start Game</button>
    </div>
  </div>
  <div class="container" id="main-screen" style="display: none;">
    <h1>Blackjack Card Counting PWA</h1>
    <div class="dealer">
      <h2 id="dealer-name">Dealer</h2>
      <div class="cards" id="dealer-cards"></div>
      <div>Hand Value: <span id="dealer-value">0</span></div>
    </div>
    <div id="players-container"></div>
    <div class="count-display">
      Running Count: <span id="running-count">0</span>
    </div>
    <div class="suggested-play">
      Suggested Play: <span id="suggested-play">N/A</span>
    </div>
    <div class="card-buttons">
      <button onclick="addCard(1)">1</button>
      <button onclick="addCard(2)">2</button>
      <button onclick="addCard(3)">3</button>
      <button onclick="addCard(4)">4</button>
      <button onclick="addCard(5)">5</button>
      <button onclick="addCard(6)">6</button>
      <button onclick="addCard(7)">7</button>
      <button onclick="addCard(8)">8</button>
      <button onclick="addCard(9)">9</button>
      <button onclick="addCard(10)">10</button>
      <button onclick="addCard('J')">J</button>
      <button onclick="addCard('Q')">Q</button>
      <button onclick="addCard('K')">K</button>
      <button onclick="addCard('A')">A</button>
    </div>
    <div class="fixed-buttons">
      <button onclick="nextPlayer()">Next Player</button>
      <button onclick="roundOver()">Round Over</button>
      <button onclick="deckShuffle()">Deck Shuffle</button>
      <button onclick="deleteEntry()">Delete Entry</button>
    </div>
  </div>
  <script>
    let runningCount = 0;
    let currentPlayerIndex = 1; // Start with the first player
    let userPosition;
    let numDecks;
    const players = [];
    const originalPlayers = [];
    const cardValues = {
      '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 0, '8': 0, '9': 0, '10': 10, 'J': 10, 'Q': 10, 'K': 10, 'A': 11
    };
    const hiLowValues = {
      '2': 1, '3': 1, '4': 1, '5': 1, '6': 1, '7': 0, '8': 0, '9': 0, '10': -1, 'J': -1, 'Q': -1, 'K': -1, 'A': -1
    };
    const basicStrategy = {}; // Object to store basic strategy suggestions
    const history = [];
    let model = {};

    async function startGame() {
      const numPlayers = parseInt(document.getElementById('num-players').value);
      numDecks = parseInt(document.getElementById('num-decks').value);
      userPosition = parseInt(document.getElementById('user-position').value);

      if (!numPlayers || !numDecks || !userPosition) {
        alert('Please fill out all fields.');
        return;
      }

      for (let i = 0; i < numPlayers; i++) {
        const playerName = (i + 1) === userPosition ? 'You' : `Player ${i + 1}`;
        players.push({ id: i + 1, name: playerName, cards: [], handValue: 0 });
        originalPlayers.push({ id: i + 1, name: playerName, cards: [], handValue: 0 });
      }

      document.getElementById('home-screen').style.display = 'none';
      document.getElementById('main-screen').style.display = 'block';

      renderPlayers();
      highlightCurrentPlayer();
      await loadModel();
    }

    async function loadModel() {
      try {
        const response = await fetch(`https://raw.githubusercontent.com/gavinks07/BlackJackAi/main/blackjack_model.json`);
        if (response.ok) {
          model = await response.json();
        } else {
          model = {};
          await saveModel();
        }
      } catch (error) {
        console.error('Error loading model:', error);
        model = {};
        await saveModel();
      }
    }

    async function saveModel() {
      const modelPath = 'blackjack_model.json';
      const githubRepo = 'gavinks07/BlackJackAi'; // Replace with your repo
      const githubToken = 'your_github_token'; // Replace with your token

      try {
        const response = await fetch(`https://api.github.com/repos/${githubRepo}/contents/${modelPath}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${githubToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: 'Update model',
            content: btoa(JSON.stringify(model))
          })
        });

        if (!response.ok) {
          throw new Error('Failed to save model');
        }
      } catch (error) {
        console.error('Error saving model:', error);
      }
    }

    function renderPlayers() {
      const playersContainer = document.getElementById('players-container');
      playersContainer.innerHTML = '';
      players.forEach(player => {
        const playerDiv = document.createElement('div');
        playerDiv.className = 'player';
        playerDiv.innerHTML = `
          <h2 id="player${player.id}-name">${player.name}</h2>
          <div class="cards" id="player${player.id}-cards"></div>
          <div>Hand Value: <span id="player${player.id}-value">0</span></div>
        `;
        playersContainer.appendChild(playerDiv);
      });
    }

    function highlightCurrentPlayer() {
      players.forEach((player, index) => {
        const playerName = document.getElementById(`player${player.id}-name`);
        if (index + 1 === currentPlayerIndex) {
          playerName.classList.add('highlight');
        } else {
          playerName.classList.remove('highlight');
        }
      });
      if (currentPlayerIndex === 0) {
        document.getElementById('dealer-name').classList.add('highlight');
      } else {
        document.getElementById('dealer-name').classList.remove('highlight');
      }
    }

    function addCard(value) {
      const currentCardValue = cardValues[value];
      const hiLowValue = hiLowValues[value];
      history.push({ playerIndex: currentPlayerIndex, value, hiLowValue });

      if (currentPlayerIndex === 0) {
        addCardToHand('dealer', currentCardValue, value);
      } else {
        const playerId = players[currentPlayerIndex - 1].id;
        addCardToHand(`player${playerId}`, currentCardValue, value);
        players[currentPlayerIndex - 1].handValue += currentCardValue;
        document.getElementById(`player${playerId}-value`).innerText = players[currentPlayerIndex - 1].handValue;
      }

      runningCount += hiLowValue / numDecks;
      document.getElementById('running-count').innerText = runningCount;
      suggestPlay();
    }

    function addCardToHand(playerId, value, displayValue) {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerText = displayValue;
      document.getElementById(`${playerId}-cards`).appendChild(card);
    }

    function nextPlayer() {
      currentPlayerIndex = (currentPlayerIndex + 1) % (players.length + 1);
      highlightCurrentPlayer();
      suggestPlay();
    }

    function roundOver() {
      players.length = 0;
      originalPlayers.forEach(player => players.push({ ...player, cards: [], handValue: 0 }));
      currentPlayerIndex = 1; // Reset to first player
      document.querySelectorAll('.cards').forEach(cardsDiv => cardsDiv.innerHTML = '');
      document.querySelectorAll('.cards + div > span').forEach(handValueSpan => handValueSpan.innerText = '0');
      document.getElementById('suggested-play').innerText = 'N/A';
      highlightCurrentPlayer();
    }

    function deckShuffle() {
      runningCount = 0;
      document.getElementById('running-count').innerText = runningCount;
      alert('Deck shuffled. Running count reset.');
    }

    function deleteEntry() {
      if (history.length === 0) return;
      
      const lastEntry = history.pop();
      currentPlayerIndex = lastEntry.playerIndex;
      const hiLowValue = lastEntry.hiLowValue;
      const value = lastEntry.value;
      
      runningCount -= hiLowValue / numDecks;
      document.getElementById('running-count').innerText = runningCount;
      
      if (currentPlayerIndex === 0) {
        // Dealer's turn
        removeLastCard('dealer', value);
      } else {
        const playerId = players[currentPlayerIndex - 1].id;
        removeLastCard(`player${playerId}`, value);
        players[currentPlayerIndex - 1].handValue -= cardValues[value];
        document.getElementById(`player${playerId}-value`).innerText = players[currentPlayerIndex - 1].handValue;
      }
      
      suggestPlay();
    }

    function removeLastCard(playerId, value) {
      const cardsDiv = document.getElementById(`${playerId}-cards`);
      const lastCard = cardsDiv.lastChild;
      if (lastCard) cardsDiv.removeChild(lastCard);
    }

    function suggestPlay() {
      const suggestedPlay = document.getElementById('suggested-play');
      const currentPlayer = players[currentPlayerIndex - 1] || { handValue: 0 };
      const handValue = currentPlayer.handValue;
      const playKey = `${handValue}-${runningCount}`;

      if (!model[playKey]) {
        if (handValue <= 11) {
          model[playKey] = 'H'; // Hit
        } else if (handValue >= 17) {
          model[playKey] = 'S'; // Stand
        } else {
          model[playKey] = runningCount >= 0 ? 'H' : 'S'; // Hit if positive count, otherwise stand
        }
      }
      suggestedPlay.innerText = model[playKey];
      saveModel();
    }

    function split(playerId) {
      const playerIndex = players.findIndex(player => player.id === playerId);
      const newPlayer = {
        id: `${playerId}a`,
        name: `${players[playerIndex].name} (a)`,
        cards: [],
        handValue: 0
      };
      players.splice(playerIndex + 1, 0, newPlayer);
      players[playerIndex].name += ' (b)';
      renderPlayers();
      highlightCurrentPlayer();
    }
  </script>
</body>
</html>
